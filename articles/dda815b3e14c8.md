---
title: "REST API ã‚’ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ç’°å¢ƒã‚’ã¤ãã‚‹"
emoji: "ğŸ¥‡"
type: "tech"
topics:
  - "aws"
  - "nodejs"
  - "ubuntu"
  - "ci"
  - "restapi"
published: true
published_at: "2024-01-13 19:40"
---

# èƒŒæ™¯
* REST API ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãŒã—ãŸã„
* ãƒ‡ã‚°ãƒ¬ãŒã“ã‚ã„ã®ã§ã€ã‹ã‚“ãŸã‚“ã«ãƒ†ã‚¹ãƒˆã™ã‚‹ç’°å¢ƒãŒã»ã—ã„

# ç›®æ¨™
* REST API ã‚’ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã™ã‚‹ç’°å¢ƒã‚’ã¤ãã‚‹
* ã‚³ãƒãƒ³ãƒ‰ã§ã‚ã‚Œã°ã€ã‚·ã‚§ãƒ«ã‚„ä»–ã®ãƒ„ãƒ¼ãƒ«ã«çµ„ã¿è¾¼ã‚“ã§ç¶™ç¶šçš„ãƒ†ã‚¹ãƒˆï¼ˆcontinuous testingï¼‰ç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚‚ç°¡å˜ã«ãªã‚Šãã†ãªã®ã§

# ãƒã‚¤ãƒ³ãƒˆï¼
* ãƒ„ãƒ¼ãƒ«ã¯stepciã‚’ä½¿ã†ï¼ˆãƒ„ãƒ¼ãƒ«ã¯ä»–ã«ã‚‚ã‚ã‚‹ãŒæ¯”è¼ƒçš„æ–°ã—ãã†ã ã£ãŸã®ã§ï¼‰
* stepciã¯nodejs v12ä»¥ä¸ŠãŒå¿…è¦
* OpenAPI specã‹ã‚‰ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã¤ãã‚‹ã¨æ¥½ã§ãã‚‹

# stepciã¨ã¯ï¼Ÿ
Step CI ã¯ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã® API å“è³ªä¿è¨¼ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
@[card](https://docs.stepci.com/)

# ç’°å¢ƒ
* Ubuntu 20.04LTS
* æœ¬å½“ã¯ã€windowsã«ç’°å¢ƒã‚’ä½œã‚ŠãŸã‹ã£ãŸãŒã€nodejsãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šä¸€æ—¦ã“ã¡ã‚‰ã§

# æ‰‹é †
## npmã¨nodejsã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
```
sudo apt update
sudo apt install nodejs
sudo apt install npm
```

## nodejsã‚’æ›´æ–°ã™ã‚‹
Ubuntu 20.04LTSã®å ´åˆã€nodejsã¯v10ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚nodejsãŒv12ã‚ˆã‚Šå‰ã ã¨å¾Œç¨‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹stepciãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€nodejsã‚’æ›´æ–°ã™ã‚‹ã€‚
ç¾åœ¨recommendedã®v18ã«æ›´æ–°ã€‚
```
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash - &&\
sudo apt-get install -y nodejs
```
@[card](https://github.com/nodesource/distributions)

## stepciã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹
ä»¥ä¸‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æƒ³å®šã€‚
é©å½“ãªãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¦ç§»å‹•ã™ã‚‹ã€‚
```
mkdir ~/resttest
cd ~/resttest
```
stepciã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚
```
npm init
npm install --save-dev stepci
```

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹
stepciã‚’runã•ã›ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼ˆworkflow.ymlï¼‰ã‚’ä½œæˆã™ã‚‹ã€‚
```
./node_modules/.bin/stepci init
```
```
Success! The workflow file can be found at workflow.yml
Enter npx stepci run workflow.yml to run it
```
ã§ããŸ workflow.yml
```
version: "1.1"
name: Status Check
env:
  host: example.com
tests:
  example:
    steps:
      - name: GET request
        http:
          url: https://${{env.host}}
          method: GET
          check:
            status: /^20/
```
â†‘GET http://example.com ã‚’å®Ÿè¡Œã—ãŸçµæœãŒ'20'ã§å§‹ã¾ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ200ã‚„201ã‚„202ãªã©ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã¨ã„ã†æ„å‘³ã€‚

ã‚‚ã—ã€OpenAPI specï¼ˆä¾‹ï¼šAWS API Gatewayã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸã‚‚ã®ï¼‰ãŒã‚ã‚Œã°ã€
```
./node_modules/.bin/stepci generate {spec} {path}
```
ã‚’ä½¿ã£ãŸæ–¹ãŒåœ§å€’çš„ã«æ—©ã„ï¼ˆå¾Œã§æ°—ã¥ã„ãŸã€‚ã€‚ã€‚ï¼‰ã€‚

ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®æ›¸ãæ–¹ã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã€‚
@[card](https://docs.stepci.com/guides/testing-http.html)

## REST API ã‚’ãƒ¯ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã™ã‚‹
```
./node_modules/.bin/stepci run workflow.yml
```
å®Ÿè¡Œçµæœã®ä¾‹
![](https://storage.googleapis.com/zenn-user-upload/92c4c55d50f0-20240113.png)

ç’°å¢ƒï¼ˆenvï¼‰ã‚’å¤‰æ›´æŒ‡å®šã™ã‚‹ã“ã¨ã‚‚å¯èƒ½
```
./node_modules/.bin/stepci run workflow.yml -e host=example2.com
```

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆã®ãƒã‚¤ãƒ³ãƒˆ
* APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¾Œç¶šã®APIãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§ä½¿ã†ã‚ˆã†ã«ã—ãŸæ–¹ãŒãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ãƒ¡ãƒ³ãƒ†ãŒæ¥½ã«ãªã‚‹ã€‚
* å„ãƒ†ã‚¹ãƒˆï¼ˆtestsé…ä¸‹ï¼‰ã¯ä¸¦è¡Œå®Ÿè¡Œã•ã‚Œã‚‹ã®ã§ã€ãƒ†ã‚¹ãƒˆã¯æ¥µåŠ›åˆ†ã‘ãŸã»ã†ãŒæ—©ãçµ‚ã‚ã‚‹ã€‚
* ãƒ‡ãƒ¼ã‚¿åé›†ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã¨ãã¯ä¸‹è¨˜ã‚’ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã«è¨­å®šã™ã‚‹ã€‚
```
env:
  STEPCI_DISABLE_ANALYTICS: "1"
```
* APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ï¼ˆsplit+nç•ªç›®ã‚’æŠ½å‡ºï¼‰ã—ã¦å¾Œç¶šã®APIã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã¨ã—ãŸã‹ã£ãŸãŒåˆ†ã‹ã‚‰ãšã€‚APIãƒ¬ã‚¹ãƒãƒ³ã‚¹è¨­è¨ˆãŒã„ã‘ã¦ãªã‹ã£ãŸã®ã‹ã‚‚ã€‚

## ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä¾‹
Cognitoã§tokenã‚’ç™ºè¡Œã—ã€ãã®tokenã‚’ä»˜ã‘ã¦GET dataã‚’ã‚³ãƒ¼ãƒ«ã€‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ200ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚
```
version: "1.1"
name: Status Check
env:
  STEPCI_DISABLE_ANALYTICS: "1"
  apiHost: https://{apigateway-id}.execute-api.{region}.amazonaws.com/{stage}
  tokenHost: https://cognito-idp.{region}.amazonaws.com/
  cognitoClientId: {cognitoclient-id}
tests:
  AdminUserTest:
    steps:
      - name: Token request
        http:
          url: ${{env.tokenHost}}
          method: POST
          headers:
            X-Amz-Target: AWSCognitoIdentityProviderService.InitiateAuth
            Content-Type: application/x-amz-json-1.1
          json:
            ClientId: ${{env.cognitoClientId}}
            AuthFlow: USER_PASSWORD_AUTH
            AuthParameters:
              USERNAME: {cognito-user}
              PASSWORD: {cognito-password}
          captures:
            idToken:
              jsonpath: $.AuthenticationResult.IdToken
          check:
            status: 200
      - name: GET data
        http:
          url: ${{env.apiHost}}/data
          method: GET
          auth:
            bearer:
              token: ${{captures.idToken}}
          check:
            status: 200
```

# å‚è€ƒæ–‡çŒ®
@[card](https://zenn.dev/kou_pg_0131/articles/stepci-introduction)
@[card](https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-ubuntu-20-04-ja)
